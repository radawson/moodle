{"version":3,"file":"modal_factory.min.js","sources":["../src/modal_factory.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Create a modal.\n *\n * @module     core/modal_factory\n * @copyright  2016 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport ModalEvents from 'core/modal_events';\nimport * as ModalRegistry from 'core/modal_registry';\nimport Modal from 'core/modal';\nimport ModalSaveCancel from 'core/modal_save_cancel';\nimport ModalDeleteCancel from 'core/modal_delete_cancel';\nimport ModalCancel from 'core/modal_cancel';\nimport ModalAlert from 'core/local/modal/alert';\nimport * as Templates from 'core/templates';\nimport * as Notification from 'core/notification';\nimport * as CustomEvents from 'core/custom_interaction_events';\nimport Pending from 'core/pending';\n\n/**\n * The available standard modals.\n *\n * @property {String} DEFAULT The default modal\n * @property {String} SAVE_CANCEL A modal which can be used to either save, or cancel.\n * @property {String} DELETE_CANCEL A modal which can be used to either delete, or cancel.\n * @property {String} CANCEL A modal which displayed a cancel button\n * @property {String} ALERT An information modal which only displays information.\n */\nexport const types = {\n    DEFAULT: 'DEFAULT',\n    SAVE_CANCEL: ModalSaveCancel.TYPE,\n    DELETE_CANCEL: ModalDeleteCancel.TYPE,\n    CANCEL: ModalCancel.TYPE,\n    ALERT: ModalAlert.TYPE,\n};\n\n// Most modals are self-registering.\n// We do not self-register the base Modal because we do not want to define a default TYPE\n// on the class that every other modal extends.\nModalRegistry.register(types.DEFAULT, Modal, Modal.TEMPLATE);\n\n/**\n * Set up the events required to show the modal and return focus when the modal\n * is closed.\n *\n * @method setUpTrigger\n * @private\n * @param {Promise} modalPromise The modal instance\n * @param {object} triggerElement The jQuery element to open the modal\n * @param {object} modalConfig The modal configuration given to the factory\n */\nconst setUpTrigger = (modalPromise, triggerElement, modalConfig) => {\n    // The element that actually shows the modal.\n    let actualTriggerElement = null;\n    // Check if the client has provided a callback function to be called\n    // before the modal is displayed.\n    const hasPreShowCallback = (typeof modalConfig.preShowCallback == 'function');\n    // Function to handle the trigger element being activated.\n    const triggeredCallback = (e, data) => {\n        const pendingPromise = new Pending('core/modal_factory:setUpTrigger:triggeredCallback');\n        actualTriggerElement = $(e.currentTarget);\n\n        // eslint-disable-next-line promise/catch-or-return\n        modalPromise.then(function(modal) {\n            if (hasPreShowCallback) {\n                // If the client provided a pre-show callback then execute\n                // it now before showing the modal.\n                modalConfig.preShowCallback(actualTriggerElement, modal);\n            }\n\n            modal.show();\n\n            return modal;\n        })\n        .then(pendingPromise.resolve);\n        data.originalEvent.preventDefault();\n    };\n\n    // The trigger element can either be a single element or it can be an\n    // element + selector pair to create a delegated event handler to trigger\n    // the modal.\n    if (Array.isArray(triggerElement)) {\n        const selector = triggerElement[1];\n        triggerElement = triggerElement[0];\n\n        CustomEvents.define(triggerElement, [CustomEvents.events.activate]);\n        triggerElement.on(CustomEvents.events.activate, selector, triggeredCallback);\n    } else {\n        CustomEvents.define(triggerElement, [CustomEvents.events.activate]);\n        triggerElement.on(CustomEvents.events.activate, triggeredCallback);\n    }\n\n    // eslint-disable-next-line promise/catch-or-return\n    modalPromise.then(function(modal) {\n        modal.getRoot().on(ModalEvents.hidden, function() {\n            // Focus on the trigger element that actually launched the modal.\n            if (actualTriggerElement !== null) {\n                actualTriggerElement.focus();\n            }\n        });\n\n        return modal;\n    });\n};\n\n/**\n * Create the correct instance of a modal based on the givem type. Sets up\n * the trigger between the modal and the trigger element.\n *\n * @method createFromElement\n * @private\n * @param {object} registryConf A config from the ModalRegistry\n * @param {object} modalElement The modal HTML jQuery object\n * @return {object} Modal instance\n */\nconst createFromElement = (registryConf, modalElement) => {\n    modalElement = $(modalElement);\n    const Module = registryConf.module;\n    const modal = new Module(modalElement);\n\n    return modal;\n};\n\n/**\n * Create the correct modal instance for the given type, including loading\n * the correct template.\n *\n * @method createFromType\n * @private\n * @param {object} registryConf A config from the ModalRegistry\n * @param {object} templateContext The context to render the template with\n * @returns {promise} Resolved with a Modal instance\n */\nconst createFromType = (registryConf, templateContext) => {\n    const templateName = registryConf.template;\n    return Templates.render(templateName, templateContext)\n        .then((html) => createFromElement(registryConf, $(html)));\n};\n\n/**\n * Create a Modal instance.\n *\n * @method create\n * @param {object} modalConfig The configuration to create the modal instance\n * @param {object} triggerElement The trigger HTML jQuery object\n * @return {promise} Resolved with a Modal instance\n */\nexport const create = (modalConfig, triggerElement) => {\n    const type = modalConfig.type || types.DEFAULT;\n    const isLarge = modalConfig.large ? true : false;\n    const isVerticallyCentered = modalConfig.verticallyCentered ? true : false;\n    // If 'scrollable' is not configured, set the modal to be scrollable by default.\n    const isScrollable = modalConfig.hasOwnProperty('scrollable') ? modalConfig.scrollable : true;\n\n    const registryConf = ModalRegistry.get(type);\n    if (!registryConf) {\n        Notification.exception({message: 'Unable to find modal of type: ' + type});\n    }\n\n    const templateContext = modalConfig.templateContext || {};\n    const pendingModalPromise = new Pending('core/modal_factory:create');\n    const modalPromise = createFromType(registryConf, templateContext)\n        .then((modal) => {\n            if (typeof modalConfig.title !== 'undefined') {\n                modal.setTitle(modalConfig.title);\n            }\n\n            if (typeof modalConfig.body !== 'undefined') {\n                modal.setBody(modalConfig.body);\n            }\n\n            if (typeof modalConfig.footer !== 'undefined') {\n                modal.setFooter(modalConfig.footer);\n            }\n\n            if (modalConfig.buttons) {\n                Object.entries(modalConfig.buttons).forEach(function([key, value]) {\n                    modal.setButtonText(key, value);\n                });\n            }\n\n            if (isLarge) {\n                modal.setLarge();\n            }\n\n            if (isVerticallyCentered) {\n                modal.setVerticallyCentered();\n            }\n\n            if (typeof modalConfig.removeOnClose !== 'undefined') {\n                // If configured remove the modal when hiding it.\n                modal.setRemoveOnClose(modalConfig.removeOnClose);\n            }\n\n            modal.setScrollable(isScrollable);\n\n            pendingModalPromise.resolve();\n            return modal;\n        });\n\n    if (typeof triggerElement !== 'undefined') {\n        setUpTrigger(modalPromise, triggerElement, modalConfig);\n    }\n\n    return modalPromise;\n};\n\nexport default {\n    create,\n    types,\n};\n"],"names":["types","DEFAULT","SAVE_CANCEL","ModalSaveCancel","TYPE","DELETE_CANCEL","ModalDeleteCancel","CANCEL","ModalCancel","ALERT","ModalAlert","ModalRegistry","register","Modal","TEMPLATE","createFromType","registryConf","templateContext","templateName","template","Templates","render","then","html","modalElement","Module","module","createFromElement","create","modalConfig","triggerElement","type","isLarge","large","isVerticallyCentered","verticallyCentered","isScrollable","hasOwnProperty","scrollable","get","Notification","exception","message","pendingModalPromise","Pending","modalPromise","modal","title","setTitle","body","setBody","footer","setFooter","buttons","Object","entries","forEach","key","value","setButtonText","setLarge","setVerticallyCentered","removeOnClose","setRemoveOnClose","setScrollable","resolve","actualTriggerElement","hasPreShowCallback","preShowCallback","triggeredCallback","e","data","pendingPromise","currentTarget","show","originalEvent","preventDefault","Array","isArray","selector","CustomEvents","define","events","activate","on","getRoot","ModalEvents","hidden","focus","setUpTrigger"],"mappings":";;;;;;;wsBA6CaA,MAAQ,CACjBC,QAAS,UACTC,YAAaC,2BAAgBC,KAC7BC,cAAeC,6BAAkBF,KACjCG,OAAQC,sBAAYJ,KACpBK,MAAOC,eAAWN,2BAMtBO,cAAcC,SAASZ,MAAMC,QAASY,eAAOA,eAAMC,gBA8F7CC,eAAiB,CAACC,aAAcC,yBAC5BC,aAAeF,aAAaG,gBAC3BC,UAAUC,OAAOH,aAAcD,iBACjCK,MAAMC,MArBW,EAACP,aAAcQ,gBACrCA,cAAe,mBAAEA,cAEH,IAAIC,EADHT,aAAaU,QACHF,eAkBLG,CAAkBX,cAAc,mBAAEO,UAW7CK,OAAS,CAACC,YAAaC,wBAC1BC,KAAOF,YAAYE,MAAQ/B,MAAMC,QACjC+B,UAAUH,YAAYI,MACtBC,uBAAuBL,YAAYM,mBAEnCC,cAAeP,YAAYQ,eAAe,eAAgBR,YAAYS,WAEtEtB,aAAeL,cAAc4B,IAAIR,MAClCf,cACDwB,aAAaC,UAAU,CAACC,QAAS,iCAAmCX,aAGlEd,gBAAkBY,YAAYZ,iBAAmB,GACjD0B,oBAAsB,IAAIC,iBAAQ,6BAClCC,aAAe9B,eAAeC,aAAcC,iBAC7CK,MAAMwB,aAC8B,IAAtBjB,YAAYkB,OACnBD,MAAME,SAASnB,YAAYkB,YAGC,IAArBlB,YAAYoB,MACnBH,MAAMI,QAAQrB,YAAYoB,WAGI,IAAvBpB,YAAYsB,QACnBL,MAAMM,UAAUvB,YAAYsB,QAG5BtB,YAAYwB,SACZC,OAAOC,QAAQ1B,YAAYwB,SAASG,SAAQ,mBAAUC,IAAKC,YACvDZ,MAAMa,cAAcF,IAAKC,UAI7B1B,SACAc,MAAMc,WAGN1B,sBACAY,MAAMe,6BAG+B,IAA9BhC,YAAYiC,eAEnBhB,MAAMiB,iBAAiBlC,YAAYiC,eAGvChB,MAAMkB,cAAc5B,cAEpBO,oBAAoBsB,UACbnB,qBAGe,IAAnBhB,gBArJM,EAACe,aAAcf,eAAgBD,mBAE5CqC,qBAAuB,WAGrBC,mBAA4D,mBAA/BtC,YAAYuC,gBAEzCC,kBAAoB,CAACC,EAAGC,cACpBC,eAAiB,IAAI5B,iBAAQ,qDACnCsB,sBAAuB,mBAAEI,EAAEG,eAG3B5B,aAAavB,MAAK,SAASwB,cACnBqB,oBAGAtC,YAAYuC,gBAAgBF,qBAAsBpB,OAGtDA,MAAM4B,OAEC5B,SAEVxB,KAAKkD,eAAeP,SACrBM,KAAKI,cAAcC,qBAMnBC,MAAMC,QAAQhD,gBAAiB,OACzBiD,SAAWjD,eAAe,GAChCA,eAAiBA,eAAe,GAEhCkD,aAAaC,OAAOnD,eAAgB,CAACkD,aAAaE,OAAOC,WACzDrD,eAAesD,GAAGJ,aAAaE,OAAOC,SAAUJ,SAAUV,wBAE1DW,aAAaC,OAAOnD,eAAgB,CAACkD,aAAaE,OAAOC,WACzDrD,eAAesD,GAAGJ,aAAaE,OAAOC,SAAUd,mBAIpDxB,aAAavB,MAAK,SAASwB,cACvBA,MAAMuC,UAAUD,GAAGE,sBAAYC,QAAQ,WAEN,OAAzBrB,sBACAA,qBAAqBsB,WAItB1C,UAoGP2C,CAAa5C,aAAcf,eAAgBD,aAGxCgB,kDAGI,CACXjB,OAAAA,OACA5B,MAAAA"}